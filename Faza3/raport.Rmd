---
title: "Model predykcji zachorowañ na raka piersi w Polsce"
author: "Patrycja Matys, Jan Rosa, Krzysztof Rutkowski, Magda Sobiczewska"
date: "17 czerwca 2016"
output: 
  html_document:
    fig_caption: yes
    toc: true
---
```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load(file="regresja_dane.Rdata")
library(knitr)
```

#Wprowadzenie

Celem trzeciej fazy by³o stworzenie modelu, który najlepiej dokona predykcji liczby zachorowañ na raka piersi w Polsce na nastêpny rok, tj. 2013 w podziale na powiat, p³eæ i grupê wiekow¹. Predykcjê dokonaliœmy bazuj¹c na danych zawieraj¹cych liczbê przypadków raka piersi w Polsce w latach 2010, 2011, 2012 z podzia³em na p³eæ, 6 grup wiekowych, fazê choroby, kod TERYT/powiat oraz województwo. Korzystaj¹c z analiz dokonanych w poprzednich fazach, uznaliœmy, ¿e dodatkowo wykorzystamy dane z Banku Danych Lokalnych GUS - dane te opisuj¹ czynniki mog¹ce wp³ywaæ na odsetek zachorowañ.

## Przygotowanie danych
Do predykcji przygotowaliœmy dane dotycz¹ce powiatów, gdzie zmienn¹ objaœnian¹ jest znormalizowany
(przez liczbê osób w powiecie) **odsetek chorych na raka piersi**. Zaœ zmiennymi objaœniaj¹cymi
s¹ czynniki wymienione w czêsci poœwiêconej metodologii. Poni¿sza tabela przedstawia omawiane zmienne:
```{r}
kable(head(y11[,1:6]))
kable(head(y11[,7:12]))
kable(head(y11[,13:18]))
```

## Sposób predykcji

Zdolonoœæ predykcyjn¹ modeli zbadaliœmy estymuj¹c model na podstawie danych z **2011** roku, a nastêpnie porównujac predykcjê modelu na **2012** roku z rzeczywistymi wartoœciami. Za kryterium obraliœmy b³¹d RMSE.

```{r include=FALSE}
mse <- function(pred, y) {
  return(mean((pred-y)^2, na.rm=TRUE))
}
rmse <- function(pred, y) {
  return(sqrt(mean((pred-y)^2, na.rm=TRUE)))
}
```

#U¿yte modele
U¿yliœmy nastêpuj¹cych metod:    
<ul>
<li> regresja liniowa </li>
<li> xgboost </li>
</ul>


##########
Widzimy, ¿e najlepiej sprawdza³y siê **regresja liniowa i xgboost**. Te metody omówimy szerzej.

##Metodologia i wybór czynników

Na podstawie literatury przedmiotu, w poprzedniej fazie zauwa¿yliœmy ¿e nastêpuj¹ce czynniki s¹ wa¿ne:
<ul>
<li>wiek</li>
<li>p³eæ</li> 
<li>stê¿enie szkodliwych py³ów</li>
<li>stê¿enie szkodliwych gazów</li>
<li>urbanizacjê</li> 
<li>gêstoœæ zaludnienia</li>
</ul> 


W trzeciej fazie postanowiliœmy dodaæ tak¿e czynniki:
<ul>
<li>spo¿ycie alkoholu wœród kobiet (dane dla województw)</li> 
<li>spo¿ycie alkoholu wœród mê¿czyzn (dane dla województw)</li> 
<li>oty³oœæ wœród kobiet (dane dla województw)</li> 
<li>oty³oœæ wœród mê¿czyzn (dane dla województw)</li> 
<li>liczbê osób zarejestrowanych w poradniach psychologicznych (o zaburzeniach niealkoholowych i nieschizofrenicznych)</li> 
<li>liczbê osób z zaburzeniami psychicznymi (dane dla województw)</li>
<li>liczbê osób chorych w poprzednim okresie</li>
</ul>
Za jedne z najwa¿niejszych przyczyn nowotworu z³oœliwego piersi jest uznawane spo¿ycie alkoholu oraz oty³oœæ, z tego powodu dodaliœmy pierwsze cztery czynniki. Za bardzo wa¿ny determinant uznawany jest równie¿ wysoki poziom stresu, który przybli¿aæ maj¹ zmienne opisuj¹ce liczbê osób z problemami psychicznymi. 

    
##Modele liniowe
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(glmnet)
library(knitr)
mse <- function(pred, y) {
  return(mean((pred-y)^2, na.rm=TRUE))
}
rmse <- function(pred, y) {
  return(sqrt(mean((pred-y)^2, na.rm=TRUE)))
}
```
W pierwszej kolejnoœci oszacowalismy i przetestowaliœmy modele linowe. Moc predykcyjn¹ przetestowaliœmy opisan¹ wy¿ej metod¹.

Z modeli linowych na pocz¹tku oszacowano zwyk³y model regresji. W zbiorze zmiennych objaœnianych znalaz³y siê wszystkie rozwa¿ane przez nas zmienne, a tak¿e interakcje miêdzy wiekiem a urbanizacj¹. Pierwszy model wykorzystywa³ wszystkie zmienne, drugi czynniki wybrane na podstawie kryterium BIC. Otrzymano nastêpuj¹ce modele:

```{r cars, echo=FALSE}
#print(getwd())
load(file="regresja_dane.Rdata")
fit1_normal1<-lm(zm_dec.x~ GAZY +GESTOSC+ZIELONE+ URBANIZACJA+
                   ZAGROZENIA+PYLY+GENDER*Fotytly*URBANIZACJA+
                   GENDER*Falkohol*URBANIZACJA+GENDER*Motytly+GENDER*Malkohol+
                   URBANIZACJA+as.factor(AGE_GROUP)*URBANIZACJA+nsrednia.y+zsrednia.y+nsrednia.y*URBANIZACJA+opoznienie, data=y11)

fit1_aic<-step(fit1_normal1,data=grupa_m3, direction="backward",criterion = "BIC", trace=0)
summary(fit1_normal1)
summary(fit1_aic)

```

Jak widaæ w obu przypadkach, za istotne zmienne, na podstawie testu t, nale¿y uznaæ: urbanizacjê, gestoœæ zaludnienia, wiek, poziom spo¿ycia alkoholu wœród kobiet, a tak¿e liczbê osób zarejestrowanych w poradniach psychologicznych.  

```{r kable, echo=FALSE, warning=FALSE}
res <- data.frame(matrix(ncol=2, nrow=2))
colnames(res) <- c("model", "wyniki")
res$model <- c("normal", "aic")
res$wyniki <- c(rmse(predict(fit1_normal1,y12), y12$zm_dec.x)*10^5, 
                rmse(predict(fit1_aic,y12), y12$zm_dec.x)*10^5)
kable(res)

```

Nastêpnie oszacowano uogólnione modele regresji: 

1) Wykorzystuj¹ce wszystkie z opracowanych przez nas zmiennych (analogicznie z pierwszym modelem regresji liniowej). 

2) Uogólnione modele regresji wykorzystuj¹ce te zmienne, które u¿yliœmy do szacowania modelu regresji linowej wybranego na podstawie kryterium BIC.

Analogicznie do modeli regresji liniowej przetestowano ich moc predykcyjn¹.
Za wspó³czynnik alfa przyjêto:

<ul>
<li>1.0 (lasso)</li>
<li>0.5</li> 
<li>0.25</li> 
<li>0.0 (ridge)</li> 
</ul>

```{r, echo=FALSE}
f <- as.formula(zm_dec.x~ GAZY +GESTOSC+ZIELONE+ URBANIZACJA+
                  ZAGROZENIA+PYLY+Fotytly*URBANIZACJA+
                  Falkohol+Motytly+GENDER*Malkohol+
                  URBANIZACJA+as.factor(AGE_GROUP)+nsrednia.y+zsrednia.y
                +nsrednia.y*URBANIZACJA+opoznienie)
                
options(na.action='na.omit')

x1 <- model.matrix(f, y11,na.action=NULL)
x2<-as.data.frame(x1)
y1 <- na.omit(y11)
library(glmnet)

wynik_cv_lasso<-cv.glmnet(x=x1,y=as.matrix(y1[,17]), alpha=1)
wynik_cv_ridge<-cv.glmnet(x=x1,y=as.matrix(y1[,17]),alpha=0)
wynik_cv_pol<-cv.glmnet(x=x1,y=as.matrix(y1[,17]),alpha=1/2)
wynik_cv_pol1<-cv.glmnet(x=x1,y=as.matrix(y1[,17]),alpha=1/4)


y12<-subset(y12, TERYT4!=1461)
y2 <- na.omit(y12)
y21 <- y12[complete.cases(y12),]

wynik_cv_lasso_pred<-predict.cv.glmnet(object =wynik_cv_lasso,newx=model.matrix(f, y12,na.action=NULL),)
wynik_cv_ridge_pred<-predict.cv.glmnet(object =wynik_cv_ridge,newx=model.matrix(f, y12,na.action=NULL),)
wynik_cv_pol_pred<-predict.cv.glmnet(object =wynik_cv_pol,newx=model.matrix(f, y12,na.action=NULL),)
wynik_cv_pol1_pred<-predict.cv.glmnet(object =wynik_cv_pol1,newx=model.matrix(f, y12,na.action=NULL),)


```

Wyniki dla uogólnionych modeli:

```{r, echo=FALSE}
res <- data.frame(matrix(ncol=2, nrow=4))
colnames(res) <- c("model", "wyniki")
res$model <- c("lasso", "ridge", "alfa 0.5", "alfa 0.25")
res$wyniki <- c(rmse(y2[,17], wynik_cv_lasso_pred)*10^5, 
                rmse(y2[,17], wynik_cv_ridge_pred)*10^5,
                rmse(y2[,17], wynik_cv_pol_pred)*10^5,
                rmse(y2[,17], wynik_cv_pol1_pred)*10^5)
kable(res)
```


```{r, echo=FALSE}
f1<-formula(fit1_aic)

x1 <- model.matrix(f1, y11,na.action=NULL)
y1 <- na.omit(y11)


wynik_cv_lasso<-cv.glmnet(x=x1,y=as.matrix(y1[,17]), alpha=1)
wynik_cv_ridge<-cv.glmnet(x=x1,y=as.matrix(y1[,17]),alpha=0)
wynik_cv_pol<-cv.glmnet(x=x1,y=as.matrix(y1[,17]),alpha=1/2)
wynik_cv_pol1<-cv.glmnet(x=x1,y=as.matrix(y1[,17]),alpha=1/4)



y2 <- na.omit(y12)

wynik_cv_lasso_pred<-predict.cv.glmnet(object =wynik_cv_lasso,newx=model.matrix(f1, y12,na.action=NULL),)
wynik_cv_ridge_pred<-predict.cv.glmnet(object =wynik_cv_ridge,newx=model.matrix(f1, y12,na.action=NULL),)
wynik_cv_pol_pred<-predict.cv.glmnet(object =wynik_cv_pol,newx=model.matrix(f1, y12,na.action=NULL),)
wynik_cv_pol1_pred<-predict.cv.glmnet(object =wynik_cv_pol1,newx=model.matrix(f1, y12,na.action=NULL),)


res <- data.frame(matrix(ncol=2, nrow=4))
colnames(res) <- c("model", "wyniki")
res$model <- c("lasso", "ridge", "alfa 0.5", "alfa 0.25")
res$wyniki <- c(rmse(y2[,17], wynik_cv_lasso_pred)*10^5, 
                rmse(y2[,17], wynik_cv_ridge_pred)*10^5,
                rmse(y2[,17], wynik_cv_pol_pred)*10^5,
                rmse(y2[,17], wynik_cv_pol1_pred)*10^5)
kable(res)

```

Ostateczne wyniki przedstawia tabela:

```{r, echo=FALSE}
head(res)
```

Ostatecznie, przetestowanie mocy predykcyjnej modeli na danych z 2012 roku wskaza³o, i¿ najlepiej radzi sobie model liniowy z zestawem zmiennych wybranych na podstawie kryterium BIC.  

Przeprowadzono tak¿e analizy dla modeli estymowanych osobno dla ka¿dej p³ci, jednak ich moc predykcyjna okaza³a sie zdecydowanie gorsza.


##Pozosta³e modele
Przetestowaliœmy równie¿ szereg innych modeli. Analiza zosta³a wykonana z wykorzystaniem pakietu "caret"
oraz przeszukiwanie kombinacji parametrów, które daj¹ najlepsze wyniki. Do doboru parametrów u¿yliœmy
10-krotnej kroswalidacji, zaœ walidacjê wykonaliœmy na zbiorze z 2012 roku, tak jak dla modeli liniowych.
Przetestowaliœmy nastêpuj¹ce modele:
<ul>
<li>random forest</li>
<li>gradient boosting</li> 
<li>gradient boosting z selekcj¹ atrybutów</li> 
<li>SVM</li> 
<li>knn z metryk¹ wa¿on¹ przez wa¿noœæ atrybutu</li>
</ul>
Selekcjê atrybutów dla boostingu wykonywaliœmy za pomoc¹ korelacji Pearsona.
Dla metody knn, przeskalowaliœmy wszystkie atrybuty, oraz pomno¿yliœmy ka¿d¹ cechê przez wagê uzyskan¹
z korelacji miêdzy zmienn¹ decyzyjn¹:

```{r, eval=FALSE}
scaled.data <- data.frame(scale(data))
weights <- rank.correlation(dec ~ ., scaled.data)$attr_importance
knn.data <- t( t(scaled.data) * weights)
```

Uzyskaliœmy nastêpuj¹ce wyniki:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
load(file="svmFit.Rdata")
load(file="gbmFit.Rdata")
load(file="gbmFitSel.Rdata")
load(file="knnFit.Rdata")
load(file="rfFit.Rdata")
load(file="knn_data.Rdata")
res <- data.frame(matrix(ncol=2, nrow=5))
colnames(res) <- c("model", "wyniki")
res$model <- c("gbm z selekcj¹", "gbm", "knn", "random forest", "svm")
res$wyniki <- c(rmse(y2[,17], predict(gbmFitSel, y2[,-17]))*10^5, 
                rmse(y2[,17], predict(gbmFit, y2[,-17]))*10^5,
                rmse(knn.data[,17], predict(knnFit, knn.data[,-17]))*10^5,
                rmse(y2[,17], predict(rfFit, y2[,-17]))*10^5,
                rmse(y2[,17], predict(svmFit, y2[,-17]))*10^5)
kable(res)
```

Widzimy, ¿e najlepsze wyniki zosta³y uzyskane metod¹ boostingu z selekcj¹ atrybutów.

#Koñcowy model

Na podstawie analizy b³êdów zdecydowaliœmy siê na zastosowanie modelu "mieszanego", który sk³ada siê z __gradient boosting__ oraz __regresji liniowej__.

Opis wybranego modelu:
<ul>
<li>nie rozpatrujemy podzia³u na grupy wiekowe (nie zauwa¿yliœmy znacz¹cych ró¿nic miêdzy modelami)</li>
<li>rozpatrujemy podzia³ na p³eæ</li>
<li>dla mê¿czyzn stosujemy model gradient boosting</li>
<li>dla kobiet rozpatrujemy podzia³ na TERYT,  odciêcia zosta³y wykonane na podstawie funkcji:</li>
</ul>

```{r, eval=FALSE}
teryt.groups$is_linear <- teryt.groups$bool_difs < 0 & teryt.groups$difs < -1e-05 
teryt.groups$is_boost <- teryt.groups$bool_difs > 0 & teryt.groups$difs > 1e-05 
teryt.groups$clf <- teryt.groups$is_linear * 1 + teryt.groups$is_boost * -1
```
 
zatem w zale¿noœci od wielkoœci ró¿nic œrednich znaków (bool_difs) oraz ró¿nic w œrednich (difs) (progi +/-1e-05 zosta³y dobrane na podstawie Wykresu b³êdów -  _patrz poni¿ej_) stosujemy regresjê liniow¹ (clf=1) lub gradient boosting (clf=-1) oraz zdecydowaliœmy, ¿e w przypadku braku wyraŸnej ró¿nicy miêdzy modelami (clf=0) zastosujemy gradient boosting.

__Wykres b³êdów__ (oœ pozioma to numer TERYT):

<center>
<img src="roznice.png" />
</center>

Powy¿szy opis ilustruje drzewo decyzyjne:

<center>
<img src="drzewo.png" />
</center>

#Prezentacja wyników 

Na poni¿szych kartogramach prezentujemy predykcjê na rok 2013 odsetek zachorowañ z podzia³em na p³eæ:

<center>
<img src="kobiety.png" />

<img src="mezczyzni.png" />
<center/>

#Podsumowanie

Na podstawie liniowej korelacji Pearsona, spoœród zgromadzonych czynników jako najistotniejsze wybraliœmy nastêpuj¹ce: gêstoœæ zaludnienia, urbanizacjê, wiek, poziom spo¿ycia alkoholu wœród kobiet oraz liczbê osób zarejestrowanych w poradniach psychologicznych. Przetestowanie mocy predykcyjnej modeli wskaza³o, i¿ najlepiej radzi sobie gradient boosting z selekcj¹ atrybutów, gradient boosting oraz model liniowy z zestawem zmiennych wybranych na podstawie kryterium BIC. W oparciu o analizê b³êdów, ostatecznie zdecydowaliœmy siê na zastosowanie modelu “mieszanego”, który sk³ada siê z gradient boosting oraz regresji liniowej.